name: HACS Action

on:
  push:
  pull_request:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions: {}

jobs:
  hacs:
    name: HACS Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run HACS validation
        uses: "hacs/action@main"
        with:
          category: integration
          ignore: brands

      - name: Validation with hassfest
        uses: "home-assistant/actions/hassfest@master"

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff check
        run: ruff check custom_components/

      - name: Run ruff format check
        run: ruff format --check custom_components/

  tests:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r requirements_test.txt

      - name: Run tests
        run: pytest tests/ -v --tb=short

  release:
    name: Create Release Zip
    runs-on: ubuntu-latest
    needs: [hacs, lint, tests]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create ZIP file
        run: |
          zip -r eaton_battery_storage.zip . -x "*.git*" -x "*.github*" -x "tests/*"

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          files: eaton_battery_storage.zip
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_ZIP }}
